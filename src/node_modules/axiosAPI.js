const axios = require('axios');
const globalStore = require('marko-globals');

module.exports = function api(url, config, options = {}) {
  const env = (process && process.env) || {};
  const API_BASE_URL = env.API_BASE_URL || globalStore.get('env.API_BASE_URL');
  const apiToken = options.apiToken || globalStore.get('apiToken');

  const ax = axios.create({
    baseURL: API_BASE_URL,
    headers: {
      Accept: 'application/json',
      Authorization: `Bearer ${apiToken}`,
      'Content-Type': 'application/json; charset=utf-8',
    },

    // Check if we have access to the express app. If so, short circuit requests
    // through there
  });

  const finalConig = Object.assign({}, { url }, config);
  return ax.request(finalConig);
};
